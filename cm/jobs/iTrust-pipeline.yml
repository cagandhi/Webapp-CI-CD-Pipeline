- job:
    name: iTrust
    project-type: pipeline
    dsl: |
        pipeline {
            agent any

            stages {
                stage('Source') {
                    steps {
                        git branch: 'main', url: 'https://github.ncsu.edu/engr-csc326-staff/iTrust2-v8.git', credentialsId: 'gitncsucred'
                    }
                }
                stage('Pre-Build - Set application.yml file for iTrust2'){
                    steps{
                        sh "cp iTrust2/src/main/resources/application.yml.template iTrust2/src/main/resources/application.yml"
                        sh '. /etc/environment && sed -i "s/^    password:.*$/    password: $MYSQL_ROOT_PASSWORD/g" iTrust2/src/main/resources/application.yml'
                    }
                }
                stage('Build and Test - Run unit and integration tests') {
                    steps {
                        sh "cd iTrust2/ && sudo mvn clean test integration-test checkstyle:checkstyle"
                    }
                }
            }

            post{
                always{
                    sh "sudo mysql -u$MYSQL_ROOT_USER -p$MYSQL_ROOT_PASSWORD -P3306 -e \'DROP DATABASE IF EXISTS iTrust2_test\'"
                    sh "pgrep chrome | sudo xargs kill -9"
                    sh "sudo kill \$(lsof -t -i:9001)"
                }
            }
        }
